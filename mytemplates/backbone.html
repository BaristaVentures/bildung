<html>
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
    <script src="http://ajax.cdnjs.com/ajax/libs/json2/20110223/json2.js"></script>
    <script src="http://ajax.cdnjs.com/ajax/libs/underscore.js/1.1.6/underscore-min.js"></script>
    <script src="http://ajax.cdnjs.com/ajax/libs/backbone.js/0.5/backbone-min.js"></script>
    
  </head>
    <body>
    <script type="text/javascript">
    
        Backbone.emulateHTTP = true;
        Backbone.emulateJSON = true;

        var PollsView = Backbone.View.extend({
	    el: $('body'),

	    events: {
		'click button#add_poll':'addPoll'
	    },
	    
	    initialize: function(){
		//_.bindAll(this, 'render', 'addPoll');

		this.collection = new Polls();
		this.collection.bind('add', this.appendPoll);

		this.render();
	    },
	    
	    render: function(){

		var self_view = this;
		this.collection = new Polls();
		this.collection.fetch({
		    success: function(){
			$(self_view.el).append("<ul></ul>");
			_(self_view.collection.models).each(function(poll){
			    self_view.appendPoll(poll);
			}, self_view);
		    }
		});
		//$(this.el).append("<button id='add_poll'>Add Poll</button>");
		

	    },

	    addPoll: function(){
		var poll_question = $("#poll_question").val();
		var poll_pub_date = $("#poll_pub_date").val();
		var poll = new Poll();
		poll.set({
		    question: poll_question, 
		    pub_date: poll_pub_date
		});
		poll.save();
		this.collection.add(poll);
	    },

	    appendPoll: function(poll){
		var pollView = new PollView({
		    model: poll
		});
		$('ul', this.el).append(pollView.render().el);
	    }

	});

        var PollView = Backbone.View.extend({
	    tagName: 'li',
	    
	    events: {
		'click button.delete_poll':'remove'
	    },
	    
	    render: function(){
		$(this.el).html('<span>' + this.model.get('question') + '</span><button class=delete_poll>Delete</button>');
		return this;
	    },

	    remove: function(){
		$(this.el).remove();
		alert(this.model.get('id'));
	    }
	});

        var Polls = Backbone.Collection.extend({
	    model: Poll,
	    url: "/api/v1/polls/",

	    parse: function(data){
		return data.objects;
	    }

	});

        var Poll = Backbone.Model.extend({
	    // defaults: {
	    // 	question: "Is this a poll?",
	    // 	pub_date: "2012-08-10T22:12:13+00:00"
	    // },
	    urlRoot: "/api/v1/polls/",
	    
	    url: function(){
	    	var base = this.urlRoot;
	    	return base;
	    },

	});

        var pollsView = new PollsView();
var polls = new Polls();
// polls.fetch({
//     success: function(){
// 	alert(polls.models);
//     }
// });
//alert(polls.at(0));
//alert(models);
//poll.save();
//poll.destroy();
//var poll = new Poll({ question: "Is it working now 2?", pub_date: "2012-08-10T22:12:13+00:00" });

//poll.save();

        var Choice = Backbone.Model.extend({
	    defaults:{
		choice: "this is a choice.",
		votes: 0,
		poll: new Poll()
	    }
	});

        var AppRouter = Backbone.Router.extend({
	    routes: {
		"/polls/:id": "getPoll",
		"*actions": "defaultRoute"
	    },

	    getPoll: function(id){
		console.log(id);
	    },

	    defaultRoute: function(actions){
		var polls = new Polls();
		console.log(polls);
	    }
	});

        var app_router = new AppRouter();
        Backbone.history.start();

    </script>
      <label>Question:</label>
      <input id="poll_question" />
      <label>Publicaton Date:</label>
      <input id="poll_pub_date" />
      <button id="add_poll">Add poll</button>
    </body>
</html>
